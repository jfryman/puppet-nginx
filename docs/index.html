<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; Documentation by YARD 0.9.10
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="puppet_class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="puppet_class_list_link"
        href="puppet_class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1>NGINX module for Puppet</h1>

<p><a href="https://travis-ci.org/voxpupuli/puppet-nginx"><img src="https://travis-ci.org/voxpupuli/puppet-nginx.png?branch=master" alt="Build Status"></a>
<a href="https://coveralls.io/github/voxpupuli/puppet-nginx"><img src="https://coveralls.io/repos/github/voxpupuli/puppet-nginx/badge.svg?branch=master" alt="Code Coverage"></a>
<a href="https://forge.puppetlabs.com/puppet/nginx"><img src="https://img.shields.io/puppetforge/v/puppet/nginx.svg" alt="Puppet Forge"></a>
<a href="https://forge.puppetlabs.com/puppet/nginx"><img src="https://img.shields.io/puppetforge/dt/puppet/nginx.svg" alt="Puppet Forge - downloads"></a>
<a href="https://forge.puppetlabs.com/puppet/nginx"><img src="https://img.shields.io/puppetforge/e/puppet/nginx.svg" alt="Puppet Forge - endorsement"></a>
<a href="https://forge.puppetlabs.com/puppet/nginx"><img src="https://img.shields.io/puppetforge/f/puppet/nginx.svg" alt="Puppet Forge - scores"></a></p>

<p>This module was migrated from James Fryman <a href="mailto:james@frymanet.com">james@frymanet.com</a> and
Matthew Haughton <a href="mailto:matt@3flex.com.au">matt@3flex.com.au</a> to Vox Pupuli.</p>

<h2>INSTALLING OR UPGRADING</h2>

<p><strong>Please note</strong>: This module is undergoing some structural maintenance.
You may experience breaking changes between minor versions.</p>

<p>This module manages NGINX configuration.</p>

<h3>Requirements</h3>

<ul>
<li>Puppet 4.6.1 or later.  Puppet 3 was supported up until release 0.6.0.</li>
<li>apt is now a soft dependency. If your system uses apt, you&#39;ll need to configure an appropriate version of the apt module.</li>
</ul>

<h3>Additional Documentation</h3>

<ul>
<li><a href="https://github.com/voxpupuli/puppet-nginx/blob/master/docs/quickstart.md">A Quickstart Guide to the NGINX Puppet Module</a></li>
</ul>

<h3>Install and bootstrap an NGINX instance</h3>

<pre class="code puppet"><code class="puppet">class { &#39;nginx&#39;: }
</code></pre>

<h3>A simple reverse proxy</h3>

<pre class="code puppet"><code class="puppet">nginx::resource::server { &#39;kibana.myhost.com&#39;:
  listen_port =&gt; 80,
  proxy       =&gt; &#39;http://localhost:5601&#39;,
}
</code></pre>

<h3>A virtual host with static content</h3>

<pre class="code puppet"><code class="puppet">nginx::resource::server { &#39;www.puppetlabs.com&#39;:
  www_root =&gt; &#39;/var/www/www.puppetlabs.com&#39;,
}
</code></pre>

<h3>A more complex proxy example</h3>

<pre class="code puppet"><code class="puppet">nginx::resource::upstream { &#39;puppet_rack_app&#39;:
  members =&gt; [
    &#39;localhost:3000&#39;,
    &#39;localhost:3001&#39;,
    &#39;localhost:3002&#39;,
  ],
}

nginx::resource::server { &#39;rack.puppetlabs.com&#39;:
  proxy =&gt; &#39;http://puppet_rack_app&#39;,
}
</code></pre>

<h3>Add a smtp proxy</h3>

<pre class="code puppet"><code class="puppet">class { &#39;nginx&#39;:
  mail =&gt; true,
}

nginx::resource::mailhost { &#39;domain1.example&#39;:
  auth_http   =&gt; &#39;server2.example/cgi-bin/auth&#39;,
  protocol    =&gt; &#39;smtp&#39;,
  listen_port =&gt; 587,
  ssl_port    =&gt; 465,
  starttls    =&gt; &#39;only&#39;,
  xclient     =&gt; &#39;off&#39;,
  ssl         =&gt; true,
  ssl_cert    =&gt; &#39;/tmp/server.crt&#39;,
  ssl_key     =&gt; &#39;/tmp/server.pem&#39;,
}
</code></pre>

<h2>SSL configuration</h2>

<p>By default, creating a server resource will only create a HTTP server. To also
create a HTTPS (SSL-enabled) server, set <code>ssl =&gt; true</code> on the server. You will
have a HTTP server listening on <code>listen_port</code> (port <code>80</code> by default) and a HTTPS
server listening on <code>ssl_port</code> (port <code>443</code> by default). Both servers will have
the same <code>server_name</code> and a similar configuration.</p>

<p>To create only a HTTPS server, set <code>ssl =&gt; true</code> and also set <code>listen_port</code> to the
same value as <code>ssl_port</code>. Setting these to the same value disables the HTTP server.
The resulting server will be listening on <code>ssl_port</code>.</p>

<h3>Locations</h3>

<p>Locations require specific settings depending on whether they should be included
in the HTTP, HTTPS or both servers.</p>

<h4>HTTP only server (default)</h4>

<p>If you only have a HTTP server (i.e. <code>ssl =&gt; false</code> on the server) make sure you
don&#39;t set <code>ssl =&gt; true</code> on any location you associate with the server.</p>

<h4>HTTP and HTTPS server</h4>

<p>If you set <code>ssl =&gt; true</code> and also set <code>listen_port</code> and <code>ssl_port</code> to different
values on the server you will need to be specific with the location settings since
you will have a HTTP server listening on <code>listen_port</code> and a HTTPS server listening
on <code>ssl_port</code>:</p>

<ul>
<li>To add a location to only the HTTP server, set <code>ssl =&gt; false</code> on the location
(this is the default).</li>
<li>To add a location to both the HTTP and HTTPS server, set <code>ssl =&gt; true</code> on the
location, and ensure <code>ssl_only =&gt; false</code> (which is the default value for <code>ssl_only</code>).</li>
<li>To add a location only to the HTTPS server, set both <code>ssl =&gt; true</code>
and <code>ssl_only =&gt; true</code> on the location.</li>
</ul>

<h4>HTTPS only server</h4>

<p>If you have set <code>ssl =&gt; true</code> and also set <code>listen_port</code> and <code>ssl_port</code> to the
same value on the server, you will have a single HTTPS server listening on
<code>ssl_port</code>. To add a location to this server set <code>ssl =&gt; true</code> and
<code>ssl_only =&gt; true</code> on the location.</p>

<h2>Hiera Support</h2>

<p>Defining nginx resources in Hiera.</p>

<pre class="code yaml"><code class="yaml">nginx::nginx_upstreams:
  &#39;puppet_rack_app&#39;:
    ensure: present
    members:
      - localhost:3000
      - localhost:3001
      - localhost:3002
nginx::nginx_servers:
  &#39;www.puppetlabs.com&#39;:
    www_root: &#39;/var/www/www.puppetlabs.com&#39;
  &#39;rack.puppetlabs.com&#39;:
    proxy: &#39;http://puppet_rack_app&#39;
nginx::nginx_locations:
  &#39;static&#39;:
    location: &#39;~ &quot;^/static/[0-9a-fA-F]{8}\/(.*)$&quot;&#39;
    server: www.puppetlabs.com
    www_root: /var/www/html
  &#39;userContent&#39;:
    location: /userContent
    server: www.puppetlabs.com
    www_root: /var/www/html
nginx::nginx_mailhosts:
  &#39;smtp&#39;:
    auth_http: server2.example/cgi-bin/auth
    protocol: smtp
    listen_port: 587
    ssl_port: 465
    starttls: only
</code></pre>

<h3>A stream syslog UDP proxy</h3>

<pre class="code yaml"><code class="yaml">nginx::nginx_cfg_prepend:
  include:
    - &#39;/etc/nginx/modules-enabled/*.conf&#39;

nginx::nginx_streamhosts:
  &#39;syslog&#39;:
    ensure:                 &#39;present&#39;
    listen_port:            &#39;514&#39;
    listen_options:         &#39;udp&#39;
    proxy:                  &#39;syslog&#39;
    proxy_read_timeout:     &#39;1&#39;
    proxy_connect_timeout:  &#39;1&#39;
    raw_append:
      - &#39;error_log off;&#39;

nginx::nginx_upstreams:
  &#39;syslog&#39;:
    upstream_context: &#39;stream&#39;
    members:
      - &#39;10.0.0.1:514&#39;
      - &#39;10.0.0.2:514&#39;
      - &#39;10.0.0.3:514&#39;
</code></pre>

<h2>Nginx with precompiled Passenger</h2>

<p>Example configuration for Debian and RHEL / CentOS (&gt;6), pulling the Nginx and
Passenger packages from the Phusion repo. See additional notes in
<a href="https://github.com/voxpupuli/puppet-nginx/blob/master/docs/quickstart.md">https://github.com/voxpupuli/puppet-nginx/blob/master/docs/quickstart.md</a></p>

<pre class="code puppet"><code class="puppet">class { &#39;nginx&#39;:
  package_source  =&gt; &#39;passenger&#39;,
  http_cfg_append =&gt; {
    &#39;passenger_root&#39; =&gt; &#39;/usr/lib/ruby/vendor_ruby/phusion_passenger/locations.ini&#39;,
  }
}
</code></pre>

<p>Here the example for OpenBSD:</p>

<pre class="code puppet"><code class="puppet">class { &#39;nginx&#39;:
  package_flavor =&gt; &#39;passenger&#39;,
  service_flags  =&gt; &#39;-u&#39;
  http_cfg_append =&gt; {
    passenger_root          =&gt; &#39;/usr/local/lib/ruby/gems/2.1/gems/passenger-4.0.44&#39;,
    passenger_ruby          =&gt;  &#39;/usr/local/bin/ruby21&#39;,
    passenger_max_pool_size =&gt; &#39;15&#39;,
  }
}
</code></pre>

<p>Package source <code>passenger</code> will add <a href="https://oss-binaries.phusionpassenger.com/apt/passenger">Phusion Passenger repository</a>
to APT sources. For each virtual host you should specify which ruby should be used.</p>

<pre class="code puppet"><code class="puppet">nginx::resource::server { &#39;www.puppetlabs.com&#39;:
  www_root          =&gt; &#39;/var/www/www.puppetlabs.com&#39;,
  server_cfg_append =&gt; {
    &#39;passenger_enabled&#39; =&gt; &#39;on&#39;,
    &#39;passenger_ruby&#39;    =&gt; &#39;/usr/bin/ruby&#39;,
  }
}
</code></pre>

<h3>Puppet master served by Nginx and Passenger</h3>

<p>Virtual host config for serving puppet master:</p>

<pre class="code puppet"><code class="puppet">nginx::resource::server { &#39;puppet&#39;:
  ensure               =&gt; present,
  server_name          =&gt; [&#39;puppet&#39;],
  listen_port          =&gt; 8140,
  ssl                  =&gt; true,
  ssl_cert             =&gt; &#39;/var/lib/puppet/ssl/certs/example.com.pem&#39;,
  ssl_key              =&gt; &#39;/var/lib/puppet/ssl/private_keys/example.com.pem&#39;,
  ssl_port             =&gt; 8140,
  server_cfg_append    =&gt; {
    &#39;passenger_enabled&#39;      =&gt; &#39;on&#39;,
    &#39;passenger_ruby&#39;         =&gt; &#39;/usr/bin/ruby&#39;,
    &#39;ssl_crl&#39;                =&gt; &#39;/var/lib/puppet/ssl/ca/ca_crl.pem&#39;,
    &#39;ssl_client_certificate&#39; =&gt; &#39;/var/lib/puppet/ssl/certs/ca.pem&#39;,
    &#39;ssl_verify_client&#39;      =&gt; &#39;optional&#39;,
    &#39;ssl_verify_depth&#39;       =&gt; 1,
  },
  www_root             =&gt; &#39;/etc/puppet/rack/public&#39;,
  use_default_location =&gt; false,
  access_log           =&gt; &#39;/var/log/nginx/puppet_access.log&#39;,
  error_log            =&gt; &#39;/var/log/nginx/puppet_error.log&#39;,
  passenger_cgi_param  =&gt; {
    &#39;HTTP_X_CLIENT_DN&#39;     =&gt; &#39;$ssl_client_s_dn&#39;,
    &#39;HTTP_X_CLIENT_VERIFY&#39; =&gt; &#39;$ssl_client_verify&#39;,
  },
}
</code></pre>

<h3>Example puppet class calling nginx::server with HTTPS FastCGI and redirection of HTTP</h3>

<pre class="code puppet"><code class="puppet">
$full_web_path = &#39;/var/www&#39;

define web::nginx_ssl_with_redirect (
  $backend_port         = 9000,
  $php                  = true,
  $proxy                = undef,
  $www_root             = &quot;${full_web_path}/${name}/&quot;,
  $location_cfg_append  = undef,
) {
  nginx::resource::server { &quot;${name}.${::domain}&quot;:
    ensure              =&gt; present,
    www_root            =&gt; &quot;${full_web_path}/${name}/&quot;,
    location_cfg_append =&gt; { &#39;rewrite&#39; =&gt; &#39;^ https://$server_name$request_uri? permanent&#39; },
  }

  if !$www_root {
    $tmp_www_root = undef
  } else {
    $tmp_www_root = $www_root
  }

  nginx::resource::server { &quot;${name}.${::domain} ${name}&quot;:
    ensure                =&gt; present,
    listen_port           =&gt; 443,
    www_root              =&gt; $tmp_www_root,
    proxy                 =&gt; $proxy,
    location_cfg_append   =&gt; $location_cfg_append,
    index_files           =&gt; [ &#39;index.php&#39; ],
    ssl                   =&gt; true,
    ssl_cert              =&gt; &#39;/path/to/wildcard_mydomain.crt&#39;,
    ssl_key               =&gt; &#39;/path/to/wildcard_mydomain.key&#39;,
  }


  if $php {
    nginx::resource::location { &quot;${name}_root&quot;:
      ensure          =&gt; present,
      ssl             =&gt; true,
      ssl_only        =&gt; true,
      server           =&gt; &quot;${name}.${::domain} ${name}&quot;,
      www_root        =&gt; &quot;${full_web_path}/${name}/&quot;,
      location        =&gt; &#39;~ \.php$&#39;,
      index_files     =&gt; [&#39;index.php&#39;, &#39;index.html&#39;, &#39;index.htm&#39;],
      proxy           =&gt; undef,
      fastcgi         =&gt; &quot;127.0.0.1:${backend_port}&quot;,
      fastcgi_script  =&gt; undef,
      location_cfg_append =&gt; {
        fastcgi_connect_timeout =&gt; &#39;3m&#39;,
        fastcgi_read_timeout    =&gt; &#39;3m&#39;,
        fastcgi_send_timeout    =&gt; &#39;3m&#39;
      }
    }
  }
}
</code></pre>

<h2>Add custom fastcgi_params</h2>

<pre class="code puppet"><code class="puppet">nginx::resource::location { &quot;some_root&quot;:
  ensure         =&gt; present,
  location       =&gt; &#39;/some/url&#39;,
  fastcgi        =&gt; &quot;127.0.0.1:9000&quot;,
  fastcgi_param  =&gt; {
    &#39;APP_ENV&#39; =&gt; &#39;local&#39;,
  },
}
</code></pre>

<h1>Call class web::nginx_ssl_with_redirect</h1>

<pre class="code puppet"><code class="puppet">web::nginx_ssl_with_redirect { &#39;sub-domain-name&#39;:
    backend_port =&gt; 9001,
  }
</code></pre>
</div></div>

      <div id="footer">
     Generated by <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>.
</div>

    </div>
  </body>
</html>